# P11 Task List - DevOps and Deployment

**Agent**: P11 (DevOps Engineer)
**Project**: eva-api Test Coverage to 80%+ & Deployment
**Sprint**: Sprint 1
**Status**: Not Started
**Epic**: EPIC-001
**Total Estimated Effort**: 12 hours

---

## Priority 0 (Critical - Deploy After P0 Tasks)

### Task P0-1: Prepare Azure App Service for Deployment
- **Story**: Deployment preparation
- **Description**: Configure Azure App Service (dev environment) for eva-api
- **Effort**: 2 hours
- **Configuration**:
  - App Service Plan: B1 (Basic tier for dev)
  - Runtime: Python 3.11
  - Region: Same as Cosmos DB/Blob Storage
  - Deployment method: GitHub Actions
  - Environment variables: From .env template
- **Files Affected**:
  - `.github/workflows/deploy-dev.yml` (create)
  - `azure/app-service-dev.bicep` (infrastructure as code)
- **Expected Outcome**: App Service ready to receive deployment
- **Validation**:
  - [ ] App Service provisioned
  - [ ] Environment variables configured
  - [ ] Deployment slots configured (blue/green)
  - [ ] Application Insights connected
- **Dependencies**: Azure subscription and credentials
- **Status**: [ ] Not Started

### Task P0-2: Configure CI/CD Pipeline with Coverage Reporting
- **Story**: Deployment automation
- **Description**: Update GitHub Actions to include test coverage reporting
- **Effort**: 2 hours
- **Pipeline Steps**:
  ```yaml
  - name: Run Tests with Coverage
    run: pytest --cov=src/eva_api --cov-report=xml --cov-report=term
  
  - name: Upload Coverage to Codecov
    uses: codecov/codecov-action@v3
    with:
      file: ./coverage.xml
      fail_ci_if_error: true
  
  - name: Check Coverage Threshold
    run: |
      coverage report --fail-under=52
  ```
- **Expected Outcome**: CI/CD enforces minimum coverage
- **Validation**:
  - [ ] Coverage reports generated on every PR
  - [ ] Pipeline fails if coverage drops below threshold
  - [ ] Coverage trends visible in Codecov
- **Dependencies**: None
- **Status**: [ ] Not Started

### Task P0-3: Deploy eva-api to Dev Environment
- **Story**: Initial deployment
- **Description**: Execute deployment to Azure App Service (dev)
- **Effort**: 1 hour
- **Deployment Process**:
  1. Run P09's pre-deployment checklist
  2. Trigger GitHub Actions deployment workflow
  3. Monitor deployment logs
  4. Execute smoke tests
  5. Verify Application Insights telemetry
  6. Run P09's post-deployment checklist
- **Expected Outcome**: eva-api running in dev environment
- **Validation**:
  - [ ] Deployment successful (green status)
  - [ ] Health endpoint returns 200
  - [ ] All smoke tests pass
  - [ ] Logs show no errors
- **Dependencies**: P07 P0 tasks complete, P09 sign-off
- **Status**: [ ] Not Started

---

## Priority 1 (High - Complete This Sprint)

### Task P1-1: Set Up Application Insights Monitoring
- **Story**: Observability
- **Description**: Configure comprehensive monitoring and alerting
- **Effort**: 3 hours
- **Monitoring Setup**:
  - **Metrics**: Response times, error rates, request counts
  - **Logs**: Application logs, exceptions, traces
  - **Alerts**:
    - P0: Error rate >5% for 5 minutes
    - P1: Response time p95 >2s for 10 minutes
    - P2: Failed requests >10% for 15 minutes
- **Expected Outcome**: Full observability of production behavior
- **Validation**:
  - [ ] Telemetry flowing to Application Insights
  - [ ] Custom events tracked (document uploads, queries)
  - [ ] Alerts configured and tested
  - [ ] Dashboard created for key metrics
- **Dependencies**: Deployment complete
- **Status**: [ ] Not Started

### Task P1-2: Create Rollback Plan and Test
- **Story**: Risk mitigation
- **Description**: Document and test rollback procedure
- **Effort**: 2 hours
- **Rollback Procedures**:
  1. **Slot Swap Rollback** (fastest, <1 minute):
     ```bash
     az webapp deployment slot swap --name eva-api-dev \
       --resource-group eva-rg --slot staging --target-slot production
     ```
  2. **Previous Version Redeploy** (5-10 minutes):
     - Re-trigger GitHub Actions with previous commit SHA
  3. **Manual Rollback** (15-30 minutes):
     - Deploy from local machine using Azure CLI
- **Expected Outcome**: Tested rollback plan documented
- **Validation**:
  - [ ] Rollback tested in non-prod environment
  - [ ] Rollback time < 5 minutes
  - [ ] Data integrity maintained after rollback
  - [ ] Runbook created for on-call engineers
- **Dependencies**: Deployment complete
- **Status**: [ ] Not Started

### Task P1-3: Configure Integration Test Environment
- **Story**: STORY-006
- **Description**: Set up separate environment for integration tests
- **Effort**: 2 hours
- **Environment Setup**:
  - Separate Cosmos DB container for integration tests
  - Separate Blob Storage container
  - Test-specific Azure OpenAI deployment (optional)
  - Environment variables in GitHub Secrets
- **Expected Outcome**: Integration tests can run in CI/CD
- **Validation**:
  - [ ] Integration tests pass in CI/CD
  - [ ] Test data isolated from dev/prod
  - [ ] Cleanup after tests complete
  - [ ] No cost overrun from test runs
- **Dependencies**: P07 P2 tasks (integration tests)
- **Status**: [ ] Not Started

---

## Progress Tracker

| Task | Priority | Effort | Status | Milestone | Assignee |
|------|----------|--------|--------|-----------|----------|
| P0-1 | P0 | 2h | Not Started | Pre-Deploy | P11 |
| P0-2 | P0 | 2h | Not Started | CI/CD | P11 |
| P0-3 | P0 | 1h | Not Started | Deployment | P11 |
| P1-1 | P1 | 3h | Not Started | Monitoring | P11 |
| P1-2 | P1 | 2h | Not Started | Rollback | P11 |
| P1-3 | P1 | 2h | Not Started | Integration Env | P11 |

**Total Effort**: 12 hours (P0: 5h, P1: 7h)

---

## Deployment Checklist (Summary)

**Pre-Deployment** (P09 provides):
- âœ… Coverage >= 52.92%
- âœ… P0 tests passing
- âœ… No P0/P1 blockers
- âœ… Azure services verified

**Deployment** (P11 executes):
- âœ… App Service configured
- âœ… CI/CD pipeline ready
- âœ… Environment variables set
- âœ… Deployment triggered

**Post-Deployment** (P09 validates):
- âœ… Smoke tests pass
- âœ… Health check 200
- âœ… No errors in logs
- âœ… Rollback plan ready

---

**P11 Status**: ðŸ“‹ Ready to begin
**Next Action**: Coordinate with P09 for deployment readiness
**Key Deliverable**: eva-api deployed to Azure App Service (dev)
