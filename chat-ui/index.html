<!DOCTYPE html>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                      EVA CHAT UI - THREE CONCEPTS PATTERN                     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üéØ CONTEXT_ENGINEERING
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Mission:
  Provide bilingual (EN-CA/FR-CA) chat interface for EVA RAG knowledge queries.
  Enable Canadian public servants to interact with Government of Canada documents
  in their official language of choice with accessibility compliance.

Constraints:
  - WCAG 2.2 AA compliance (keyboard nav, screen reader support, contrast ratios)
  - Bilingual EN-CA/FR-CA (no hardcoded text)
  - GC Design System visual tokens (colors, spacing, typography)
  - API key authentication required
  - 500 character message limit
  - 60-second query timeout

Reuses:
  - eva-api backend (http://127.0.0.1:8000/api/v1)
  - Cosmos DB (spaces, documents, queries metadata)
  - Azure OpenAI (RAG query processing)
  - Blob Storage (document retrieval)

Validates:
  - Message length (1-500 characters)
  - API response structure (status, data, errors)
  - Space availability before query submission
  - Language code validity (en/fr)
  - API key presence

üßπ HOUSEKEEPING
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Creates:
  - Snowflake decorations (cleanup on unload)
  - Event listeners (cleanup on unload)
  - Polling timers (cleanup after completion)
  - Modal overlays (cleanup on close)

Cleans:
  - DOM elements (snowflakes, messages)
  - setInterval/setTimeout timers
  - Event listeners
  - Cached API responses (after 5 minutes)

Monitors:
  - API connection health (30s interval)
  - Query processing status (2s polling)
  - Message count (limit 100 per session)
  - Error rates (log to console)

Validates:
  - API availability on init
  - Space data integrity
  - Query result completeness
  - User input sanitization

üìÅ WORKSPACE_MANAGEMENT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Structure:
  chat-ui/
  ‚îú‚îÄ‚îÄ index.html (this file - 1499 lines)
  ‚îú‚îÄ‚îÄ THREE-CONCEPTS-COMPLIANCE.md (refactoring plan)
  ‚îú‚îÄ‚îÄ deploy-to-azure.ps1 (Azure Static Web App deployment)
  ‚îî‚îÄ‚îÄ demo-data.json (fallback data for offline testing)

Dependencies:
  - eva-api backend (localhost:8000 or Azure App Service)
  - Browser APIs: fetch, localStorage, IntersectionObserver
  - No external libraries (vanilla JS/CSS)

Caches:
  - Language preference (localStorage.lang)
  - Spaces list (sessionStorage.spaces, 5min TTL)
  - API responses (Map object, 5min TTL)

Sessions:
  - Messages (in-memory only, cleared on refresh)
  - Current space (in-memory)
  - Connection state (in-memory)

‚ö†Ô∏è KNOWN ISSUES (from THREE-CONCEPTS-COMPLIANCE.md):
  - ‚ùå Single HTML file (should be modularized: CSS/JS separation)
  - ‚ùå Hardcoded colors (needs GC Design System tokens)
  - ‚ùå No resource cleanup on beforeunload
  - ‚ùå No health monitoring timer
  - ‚ùå No retry logic for failed API calls
  - ‚ö†Ô∏è WCAG 2.2 AA partial (needs full audit)

üîó References:
  - Three Concepts Pattern: eva-orchestrator/docs/THREE-CONCEPTS-QUICK-START.md
  - GC Design System: https://design.canada.ca/
  - WCAG 2.2: https://www.w3.org/WAI/WCAG22/quickref/
  - EVA API Docs: eva-api/docs/SPECIFICATION.md

Version: 1.0.0-holiday
Last Updated: 2025-01-08
Owner: Marco Presta
Repository: eva-api/chat-ui
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA - Joyeuses F√™tes! üéÑ Happy Holidays!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Winter Holiday Theme */
            --primary: #2E7D32;        /* Forest Green */
            --primary-dark: #1B5E20;
            --accent: #C62828;         /* Holiday Red */
            --accent-light: #EF5350;
            --gold: #FFD700;           /* Gold accents */
            --snow: #FFFFFF;
            --ice-blue: #E3F2FD;
            --winter-blue: #1976D2;
            --text-primary: #1A237E;   /* Deep blue */
            --text-secondary: #455A64;
            --bg-main: radial-gradient(ellipse at top, #1a1a3e 0%, #0d0d1f 50%, #000000 100%);
            --bg-chat: rgba(255, 255, 255, 0.95);
            --bg-message-user: #E8F5E9;
            --bg-message-eva: #FFF3E0;
            --border: #B0BEC5;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40vh;
            background: linear-gradient(to top, #1a3a1a 0%, #0d1f0d 50%, transparent 100%);
            clip-path: polygon(
                0% 100%, 0% 60%, 5% 55%, 10% 62%, 15% 58%, 20% 65%, 25% 60%, 30% 70%, 
                35% 65%, 40% 75%, 45% 70%, 50% 80%, 55% 75%, 60% 70%, 65% 75%, 70% 68%, 
                75% 72%, 80% 65%, 85% 70%, 90% 60%, 95% 65%, 100% 60%, 100% 100%
            );
            z-index: 1;
            pointer-events: none;
        }

        body::after {
            content: '‚≠ê';
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            color: gold;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.9), 0 0 60px rgba(255, 215, 0, 0.6), 0 0 90px rgba(255, 215, 0, 0.4);
            z-index: 2;
            animation: holy-star 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes holy-star {
            0%, 100% { 
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translateX(-50%) scale(1.2);
                opacity: 0.8;
            }
        }

        .star {
            position: fixed;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 3px white;
            z-index: 1;
            animation: twinkle 4s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Animated snowflakes */
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            font-size: 2.5em;
            font-family: Arial, sans-serif;
            text-shadow: 0 0 15px rgba(255, 255, 255, 1), 0 0 30px rgba(200, 220, 255, 0.8);
            z-index: 9999;
            user-select: none;
            cursor: default;
            animation-name: snowfall;
            animation-duration: 10s;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            pointer-events: none;
        }

        @keyframes snowfall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0.3;
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        header {
            background: var(--bg-chat);
            padding: 20px 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 3px solid var(--gold);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "‚ùÑÔ∏è";
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            animation: spin 10s linear infinite;
        }

        header::after {
            content: "üéÑ";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .eva-logo {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 22px;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4);
            border: 3px solid var(--gold);
        }

        .header-text h1 {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-text p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .lang-toggle {
            margin-left: auto;
            position: relative;
            width: 90px;
            height: 32px;
            background: var(--border);
            border-radius: 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border: 2px solid var(--gold);
            padding: 2px;
            transition: all 0.3s;
        }

        .lang-toggle:hover {
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .lang-slider {
            position: absolute;
            width: 42px;
            height: 26px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 13px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--gold);
        }

        .lang-slider.en {
            transform: translateX(0);
        }

        .lang-slider.fr {
            transform: translateX(44px);
        }

        .lang-btn {
            position: relative;
            width: 42px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            z-index: 1;
            transition: color 0.3s;
            border: none;
            background: none;
            cursor: pointer;
        }

        .lang-btn.active {
            color: white;
        }

        .lang-btn:not(.active) {
            color: var(--text-secondary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--primary);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .gift-box-btn {
            padding: 8px 12px;
            border: 2px solid var(--gold);
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.4);
            animation: giftPulse 2s infinite;
        }

        @keyframes giftPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(198, 40, 40, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
            }
        }

        .gift-box-btn:hover {
            transform: scale(1.2) rotate(15deg);
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.8);
        }

        /* Gift Popup Modal */
        .gift-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 20, 40, 0.95);
            animation: fadeIn 0.3s;
        }

        .gift-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .gift-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 250, 240, 0.98) 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 3px solid var(--gold);
            position: relative;
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .gift-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 32px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            background: none;
            border: none;
            line-height: 1;
        }

        .gift-close:hover {
            color: var(--accent);
            transform: rotate(90deg);
        }

        .gift-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--gold);
        }

        .gift-header h2 {
            font-size: 32px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .gift-header .subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .gift-body {
            color: var(--text-primary);
            line-height: 1.8;
        }

        .gift-body h3 {
            color: var(--primary);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 22px;
        }

        .gift-body p {
            margin-bottom: 15px;
        }

        .gift-body strong {
            color: var(--accent);
        }

        .timeline {
            background: linear-gradient(135deg, #E8F5E9 0%, #FFF8E1 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid var(--primary);
        }

        .timeline-item {
            padding: 10px 0;
            font-size: 15px;
        }

        .vision-box {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFECB3 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid var(--accent);
            font-style: italic;
        }

        .signature {
            text-align: right;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--gold);
            font-weight: 600;
            color: var(--primary);
        }

        .gift-content::-webkit-scrollbar {
            width: 8px;
        }

        .gift-content::-webkit-scrollbar-track {
            background: var(--ice-blue);
            border-radius: 10px;
        }

        .gift-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .chat-container {
            flex: 1;
            background: var(--bg-chat);
            border-radius: 16px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid var(--gold);
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
            border: 2px solid var(--gold);
        }

        .message.eva .message-avatar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: var(--ice-blue);
            color: var(--winter-blue);
        }

        .message-content {
            flex: 1;
            max-width: 85%;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.eva .message-bubble {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            border: 2px solid var(--gold);
        }

        .message.user .message-bubble {
            background: var(--bg-message-user);
            border: 2px solid var(--primary);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            padding-left: 18px;
        }

        .holiday-banner {
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
        }

        .data-sources {
            margin-top: 16px;
            padding: 18px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
        }

        .data-sources h3 {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 14px;
        }

        .source-item {
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            border: 2px solid var(--primary);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .source-name {
            font-weight: 700;
            color: var(--text-primary);
        }

        .source-docs {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 4px;
        }

        .suggested-questions {
            margin-top: 16px;
            padding: 18px;
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            border: 2px solid var(--accent);
            border-radius: 12px;
        }

        .suggested-questions h3 {
            font-size: 15px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 14px;
        }

        .question-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            background: white;
            border: 2px solid var(--gold);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .question-btn:hover {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            border-color: var(--accent);
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.2);
        }

        .question-btn::before {
            content: "üéÅ ";
            margin-right: 8px;
        }

        .input-container {
            padding: 20px 24px;
            border-top: 2px solid var(--gold);
            background: var(--bg-chat);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--gold);
            border-radius: 28px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        #messageInput:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(198, 40, 40, 0.1);
        }

        #sendBtn {
            width: 52px;
            height: 52px;
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4);
            border: 2px solid var(--gold);
        }

        #sendBtn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.6);
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--border);
        }

        .typing-indicator {
            display: none;
            padding: 14px 18px;
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            border: 2px solid var(--gold);
            border-radius: 16px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots {
            display: flex;
            gap: 6px;
        }

        .typing-dots span {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-12px);
            }
        }

        .error-message {
            padding: 14px 18px;
            background: #FFEBEE;
            border: 2px solid var(--accent);
            border-radius: 10px;
            color: var(--accent);
            font-size: 14px;
            margin-top: 12px;
            font-weight: 500;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--ice-blue);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        #messages::-webkit-scrollbar {
            width: 10px;
        }

        #messages::-webkit-scrollbar-track {
            background: var(--ice-blue);
            border-radius: 10px;
        }

        #messages::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        #messages::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Holiday decorations */
        .decoration {
            position: fixed;
            pointer-events: none;
            z-index: 1;
            font-size: 30px;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <!-- Scattered stars in the night sky -->
    <div class="star" style="top: 5%; left: 15%; animation-delay: 0s;"></div>
    <div class="star" style="top: 8%; left: 25%; animation-delay: 1s;"></div>
    <div class="star" style="top: 12%; left: 35%; animation-delay: 2s;"></div>
    <div class="star" style="top: 7%; left: 60%; animation-delay: 0.5s;"></div>
    <div class="star" style="top: 15%; left: 70%; animation-delay: 1.5s;"></div>
    <div class="star" style="top: 10%; left: 80%; animation-delay: 2.5s;"></div>
    <div class="star" style="top: 18%; left: 90%; animation-delay: 0.8s;"></div>
    <div class="star" style="top: 20%; left: 10%; animation-delay: 1.2s;"></div>
    <div class="star" style="top: 25%; left: 45%; animation-delay: 1.8s;"></div>
    <div class="star" style="top: 22%; left: 75%; animation-delay: 2.2s;"></div>
    <div class="star" style="top: 30%; left: 20%; animation-delay: 0.3s;"></div>
    <div class="star" style="top: 28%; left: 55%; animation-delay: 1.3s;"></div>
    <div class="star" style="top: 35%; left: 30%; animation-delay: 2.8s;"></div>
    <div class="star" style="top: 32%; left: 65%; animation-delay: 0.7s;"></div>
    <div class="star" style="top: 40%; left: 40%; animation-delay: 1.7s;"></div>

    <!-- Animated snowflakes -->
    <div class="snowflake" style="left: 10%; animation-duration: 12s;">‚ùÑ</div>
    <div class="snowflake" style="left: 25%; animation-duration: 9s; animation-delay: 2s;">‚ùÑ</div>
    <div class="snowflake" style="left: 40%; animation-duration: 11s; animation-delay: 4s;">‚ùÑ</div>
    <div class="snowflake" style="left: 55%; animation-duration: 10s; animation-delay: 1s;">‚ùÑ</div>
    <div class="snowflake" style="left: 70%; animation-duration: 13s; animation-delay: 3s;">‚ùÑ</div>
    <div class="snowflake" style="left: 85%; animation-duration: 8s; animation-delay: 5s;">‚ùÑ</div>

    <div class="container">
        <header>
            <div class="header-content">
                <div class="eva-logo">EVA</div>
                <div class="header-text">
                    <h1 id="headerTitle">EVA - Enterprise Virtual Assistant</h1>
                    <p id="headerSubtitle">Your Enterprise Virtual Assistant</p>
                </div>
                <div class="lang-toggle" onclick="toggleLanguage()">
                    <div class="lang-slider en" id="langSlider"></div>
                    <button class="lang-btn active" id="btnEn">EN</button>
                    <button class="lang-btn" id="btnFr">FR</button>
                </div>
                <button class="gift-box-btn" onclick="openGiftPopup()" title="Marco's Gift to Canada">üéÅ</button>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="statusText">Connected</span>
                </div>
            </div>
        </header>

        <div class="chat-container">
            <div id="messages">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <div class="input-container">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Type your question or say 'Hi EVA'..." 
                        disabled
                    />
                    <button id="sendBtn" disabled>‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://eva-api-marco-prod.azurewebsites.net';
        const API_KEY = 'demo-api-key';

        // Language state
        let currentLang = 'en';

        // Translations
        const translations = {
            fr: {
                headerTitle: "EVA - Assistant Virtuel d'Entreprise",
                headerSubtitle: "Votre Assistant Virtuel d'Entreprise",
                statusConnected: "Connect√©",
                inputPlaceholder: "Tapez votre question ou dites 'Bonjour EVA'...",
                greeting: `
                    <strong>Bonjour! Je suis EVA üéÑ</strong><br><br>
                    Je suis votre Assistant Virtuel d'Entreprise (Enterprise Virtual Assistant).
                    Je peux vous aider √† trouver des informations, r√©pondre √† vos questions
                    et analyser le contenu de vos espaces de connaissance.
                `,
                noSpaces: `
                    <strong>Aucun Espace de Connaissance Trouv√©</strong><br><br>
                    Il semble que vous n'ayez pas encore cr√©√© d'espaces de connaissance.
                    Les espaces de connaissance sont des collections de documents que je peux
                    rechercher et analyser.<br><br>
                    <em>Pour commencer, utilisez l'API pour cr√©er un espace et t√©l√©charger des documents.</em>
                `,
                availableSpaces: "Espaces de Connaissance Disponibles:",
                haveAccess: "J'ai actuellement acc√®s √†",
                space: "espace",
                spaces: "espaces",
                dataSources: "üìö Vos Sources de Donn√©es",
                documents: "documents",
                document: "document",
                created: "Cr√©√© le",
                suggestedQuestions: "üí° Essayez de me demander:",
                helloAgain: `
                    <strong>Re-bonjour! üéÖ</strong><br><br>
                    Je suis l√† et pr√™t √† vous aider. Vous pouvez me poser des questions sur
                    vos espaces de connaissance ou essayer une des questions sugg√©r√©es ci-dessus.
                `,
                answer: "R√©ponse:",
                sources: "üìé Sources:",
                page: "Page",
                errorPrefix: "‚ö†Ô∏è D√©sol√©, j'ai rencontr√© une erreur:",
                tryAgain: "Veuillez r√©essayer ou reformuler votre question.",
                questionTemplates: {
                    whatInfo: "Quelles informations sont disponibles dans",
                    summarize: "Pouvez-vous r√©sumer le contenu de",
                    keyTerms: "Quels sont les termes cl√©s dans",
                    compliance: "Y a-t-il des exigences de conformit√© mentionn√©es?",
                    mainPolicies: "Quelles sont les principales politiques d√©crites?",
                    responsible: "Qui est responsable de la mise en ≈ìuvre de ces politiques?",
                    keyFindings: "Quelles sont les principales conclusions de ces rapports?",
                    recommendations: "Quelles recommandations sont fournies?",
                    getStarted: "Comment puis-je commencer avec",
                    instructions: "Quelles sont les instructions √©tape par √©tape?",
                    topics: "Quels sujets sont couverts dans",
                    insights: "Pouvez-vous extraire les id√©es cl√©s de ce contenu?"
                },
                gift: {
                    title: "üéÅ Le Cadeau de Marco au Canada & aux Canadiens üá®üá¶",
                    subtitle: "De la vision √† la r√©alit√© ‚Ä¢ 3 ans de conception ‚Ä¢ Construit en 36 jours",
                    visionBorn: "La vision est n√©e",
                    refined: "Raffin√©, planifi√©, r√™v√©",
                    built: "Du code √† la r√©alit√© (2 nov - 8 d√©c 2025)",
                    originalVision: "La Vision Originale",
                    from: "De",
                    sent: "Envoy√©",
                    subject: "Objet",
                    dreamExpanded: "Le R√™ve s'est √âlargi",
                    evaEverywhere: "EVA partout dans les environnements Prot√©g√© B:",
                    experiencing: "Ce que Vous Exp√©rimentez Maintenant",
                    foundationText: "Ceci est <strong>l'Assistant de Domaine EVA</strong> - la fondation de cette vision. Construit avec:",
                    journey: "Le Parcours",
                    journeyText: "<strong>36 jours de d√©veloppement intense</strong> ont transform√© des ann√©es de vision en r√©alit√©:",
                    todayText: "<strong>üá®üá¶ Aujourd'hui, 8 d√©cembre 2025:</strong> Cet avenir est l√†. EVA est r√©el. Ceci est votre cadeau au Canada et aux Canadiens - une assistance accessible, bilingue et intelligente aliment√©e par une technologie d'IA de pointe.",
                    builtWith: "Construit avec üíö par Marco Presta"
                }
            },
            en: {
                headerTitle: "EVA - Enterprise Virtual Assistant",
                headerSubtitle: "Your Enterprise Virtual Assistant",
                statusConnected: "Connected",
                inputPlaceholder: "Type your question or say 'Hi EVA'...",
                greeting: `
                    <strong>Hi! I'm EVA üéÑ</strong><br><br>
                    I'm your Enterprise Virtual Assistant.
                    I can help you find information, answer questions, and analyze
                    content from your knowledge spaces.
                `,
                noSpaces: `
                    <strong>No Knowledge Spaces Found</strong><br><br>
                    It looks like you haven't created any knowledge spaces yet.
                    Knowledge spaces are collections of documents I can search and analyze.<br><br>
                    <em>To get started, use the API to create a space and upload documents.</em>
                `,
                availableSpaces: "Available Knowledge Spaces:",
                haveAccess: "I currently have access to",
                space: "space",
                spaces: "spaces",
                dataSources: "üìö Your Data Sources",
                documents: "documents",
                document: "document",
                created: "Created",
                suggestedQuestions: "üí° Try asking me:",
                helloAgain: `
                    <strong>Hello again! üéÖ</strong><br><br>
                    I'm here and ready to help. You can ask me questions about your
                    knowledge spaces or try one of the suggested questions above.
                `,
                answer: "Answer:",
                sources: "üìé Sources:",
                page: "Page",
                errorPrefix: "‚ö†Ô∏è Sorry, I encountered an error:",
                tryAgain: "Please try again or rephrase your question.",
                questionTemplates: {
                    whatInfo: "What information is available in",
                    summarize: "Can you summarize the content in",
                    keyTerms: "What are the key terms in the",
                    compliance: "Are there any compliance requirements mentioned?",
                    mainPolicies: "What are the main policies described?",
                    responsible: "Who is responsible for implementing these policies?",
                    keyFindings: "What are the key findings in these reports?",
                    recommendations: "What recommendations are provided?",
                    getStarted: "How do I get started with",
                    instructions: "What are the step-by-step instructions?",
                    topics: "What topics are covered in",
                    insights: "Can you extract key insights from this content?"
                },
                gift: {
                    title: "üéÅ Marco's Gift to Canada & Canadians üá®üá¶",
                    subtitle: "From vision to reality ‚Ä¢ 3 years in the making ‚Ä¢ Built in 36 days",
                    visionBorn: "The vision was born",
                    refined: "Refined, planned, dreamed",
                    built: "From code to reality (Nov 2 - Dec 8, 2025)",
                    originalVision: "The Original Vision",
                    from: "From",
                    sent: "Sent",
                    subject: "Subject",
                    dreamExpanded: "The Dream Expanded",
                    evaEverywhere: "EVA everywhere in Protected B environments:",
                    experiencing: "What You're Experiencing Now",
                    foundationText: "This is <strong>EVA Domain Assistant</strong> - the foundation of that vision. Built with:",
                    journey: "The Journey",
                    journeyText: "<strong>36 days of intense development</strong> transformed years of vision into working reality:",
                    todayText: "<strong>üá®üá¶ Today, December 8, 2025:</strong> That future is here. EVA is real. This is your gift to Canada and Canadians - accessible, bilingual, intelligent assistance powered by cutting-edge AI technology.",
                    builtWith: "Built with üíö by Marco Presta"
                }
            }
        };

        // State
        let spaces = [];
        let isInitialized = false;

        // DOM Elements
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        // Language switching
        function toggleLanguage() {
            const newLang = currentLang === 'fr' ? 'en' : 'fr';
            switchLanguage(newLang);
        }

        function switchLanguage(lang) {
            currentLang = lang;
            
            // Update buttons
            document.getElementById('btnFr').classList.toggle('active', lang === 'fr');
            document.getElementById('btnEn').classList.toggle('active', lang === 'en');
            
            // Update slider position
            const slider = document.getElementById('langSlider');
            slider.className = lang === 'fr' ? 'lang-slider fr' : 'lang-slider en';
            
            // Update header
            document.getElementById('headerTitle').textContent = translations[lang].headerTitle;
            document.getElementById('headerSubtitle').textContent = translations[lang].headerSubtitle;
            document.getElementById('statusText').textContent = translations[lang].statusConnected;
            messageInput.placeholder = translations[lang].inputPlaceholder;
            
            // Update gift modal
            updateGiftModal();
            
            // Always reinitialize chat to update all content
            initializeChat();
        }

        function t(key) {
            const keys = key.split('.');
            let value = translations[currentLang];
            for (const k of keys) {
                value = value[k];
            }
            return value;
        }

        function formatTime() {
            const now = new Date();
            return now.toLocaleTimeString(currentLang === 'fr' ? 'fr-CA' : 'en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function addMessage(type, content, includeTime = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = type === 'eva' ? 'üéÖ' : 'üë§';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${content}</div>
                    ${includeTime ? `<div class="message-time">${formatTime()}</div>` : ''}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            const typing = document.createElement('div');
            typing.className = 'message eva';
            typing.id = 'typing-indicator';
            typing.innerHTML = `
                <div class="message-avatar">üéÖ</div>
                <div class="message-content">
                    <div class="typing-indicator active">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typing);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        /**
         * üéØ CONTEXT_ENGINEERING: Fetch Available Knowledge Spaces
         * 
         * Mission: Retrieve list of RAG knowledge spaces from eva-api backend
         * Constraints: Requires X-API-Key header, 10s timeout
         * Reuses: eva-api /api/v1/spaces endpoint, Cosmos DB spaces container
         * Validates: HTTP status 200, data.items array presence
         * 
         * @returns {Promise<Array>} Array of space objects with {id, name, description}
         * @throws {Error} Network errors, API authentication failures, malformed responses
         * 
         * üßπ HOUSEKEEPING: No timers/listeners created (cleanup not required)
         */
        async function fetchSpaces() {
            try {
                console.log('üîç Fetching spaces from:', `${API_BASE}/api/v1/spaces`);
                const response = await fetch(`${API_BASE}/api/v1/spaces`, {
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Raw API response:', data);
                
                // Handle wrapped response format: {success: true, data: {items: [...]}}
                let spaces;
                if (Array.isArray(data)) {
                    spaces = data;
                } else if (data.data?.items) {
                    spaces = data.data.items;
                } else if (data.items) {
                    spaces = data.items;
                } else {
                    spaces = [];
                }
                
                console.log('‚úÖ Extracted spaces:', spaces.length, 'spaces found');
                return spaces;
            } catch (error) {
                console.error('‚ùå Failed to fetch spaces:', error);
                return [];
            }
        }

        function generateSuggestedQuestions(space) {
            const baseName = space.name.toLowerCase();
            const suggestions = [];
            const qt = t('questionTemplates');

            suggestions.push(`${qt.whatInfo} ${space.name}?`);
            suggestions.push(`${qt.summarize} ${space.name}?`);
            
            if (baseName.includes('contract') || baseName.includes('legal') || 
                baseName.includes('contrat') || baseName.includes('juridique')) {
                suggestions.push(`${qt.keyTerms} ${space.name}?`);
                suggestions.push(qt.compliance);
            } else if (baseName.includes('policy') || baseName.includes('procedure') ||
                       baseName.includes('politique') || baseName.includes('proc√©dure')) {
                suggestions.push(qt.mainPolicies);
                suggestions.push(qt.responsible);
            } else if (baseName.includes('report') || baseName.includes('analysis') ||
                       baseName.includes('rapport') || baseName.includes('analyse')) {
                suggestions.push(qt.keyFindings);
                suggestions.push(qt.recommendations);
            } else if (baseName.includes('manual') || baseName.includes('guide') ||
                       baseName.includes('manuel')) {
                suggestions.push(`${qt.getStarted} ${space.name}?`);
                suggestions.push(qt.instructions);
            } else {
                suggestions.push(`${qt.topics} ${space.name}?`);
                suggestions.push(qt.insights);
            }

            return suggestions.slice(0, 3);
        }

        async function initializeChat() {
            messagesContainer.innerHTML = '';
            
            // Holiday banner
            const banner = document.createElement('div');
            banner.className = 'holiday-banner';
            banner.textContent = currentLang === 'fr' 
                ? 'üéÑ Joyeuses F√™tes de la part d\'EVA! ‚ùÑÔ∏è Meilleurs v≈ìux pour 2026! üéÅ'
                : 'üéÑ Happy Holidays from EVA! ‚ùÑÔ∏è Best wishes for 2026! üéÅ';
            messagesContainer.appendChild(banner);
            
            addMessage('eva', t('greeting'));

            showTyping();
            spaces = await fetchSpaces();
            hideTyping();

            if (spaces.length === 0) {
                addMessage('eva', t('noSpaces'));
            } else {
                const spaceWord = spaces.length === 1 ? t('space') : t('spaces');
                const sourcesHTML = `
                    <strong>${t('availableSpaces')}</strong><br><br>
                    ${t('haveAccess')} <strong>${spaces.length}</strong> ${spaceWord}.
                `;
                addMessage('eva', sourcesHTML);

                if (spaces.length > 0) {
                    let questionsHTML = '<div class="suggested-questions">';
                    questionsHTML += `<h3>${t('suggestedQuestions')}</h3>`;
                    
                    // Service Canada questions
                    if (currentLang === 'fr') {
                        questionsHTML += `<button class="question-btn" onclick="askQuestion('Comment puis-je demander l\\'assurance-emploi?')">Comment puis-je demander l'assurance-emploi?</button>`;
                        questionsHTML += `<button class="question-btn" onclick="askQuestion('Quand devrais-je commencer √† recevoir le RPC?')">Quand devrais-je commencer √† recevoir le RPC?</button>`;
                    } else {
                        questionsHTML += `<button class="question-btn" onclick="askQuestion('How do I apply for Employment Insurance?')">How do I apply for Employment Insurance?</button>`;
                        questionsHTML += `<button class="question-btn" onclick="askQuestion('When should I start receiving CPP?')">When should I start receiving CPP?</button>`;
                    }
                    
                    // EVA RAG questions
                    if (currentLang === 'fr') {
                        questionsHTML += `<button class="question-btn" onclick="askQuestion('Comment fonctionne le syst√®me RAG d\\'EVA?')">Comment fonctionne le syst√®me RAG d'EVA?</button>`;
                        questionsHTML += `<button class="question-btn" onclick="askQuestion('Quelles sont les cibles de performance d\\'EVA?')">Quelles sont les cibles de performance d'EVA?</button>`;
                    } else {
                        questionsHTML += `<button class="question-btn" onclick="askQuestion('How does EVA\\'s RAG system work?')">How does EVA's RAG system work?</button>`;
                        questionsHTML += `<button class="question-btn" onclick="askQuestion('What are EVA\\'s performance targets?')">What are EVA's performance targets?</button>`;
                    }
                    
                    questionsHTML += '</div>';
                    addMessage('eva', questionsHTML);
                }
            }

            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
            isInitialized = true;
        }

        window.askQuestion = function(question) {
            messageInput.value = question;
            sendMessage();
        };

        /**
         * üéØ CONTEXT_ENGINEERING: Submit RAG Query to Backend
         * 
         * Mission: Create new query in eva-api and initiate RAG processing
         * Constraints: Requires X-API-Key, spaceId must exist, question 1-500 chars
         * Reuses: eva-api /api/v1/queries POST endpoint, Azure OpenAI, Cosmos DB
         * Validates: HTTP 201 Created, response.data.id presence
         * 
         * @param {string} spaceId - UUID of knowledge space to query
         * @param {string} question - User question (1-500 characters)
         * @returns {Promise<string>} Query ID for polling result
         * @throws {Error} Network errors, validation failures, backend errors
         * 
         * üßπ HOUSEKEEPING: No timers/listeners created (cleanup not required)
         * üìä Monitors: Tracks query submission count for rate limiting
         */
        async function submitQuery(spaceId, question) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/queries`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        space_id: spaceId,
                        question: question,
                        parameters: {}
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üì§ POST /queries response:', data);
                console.log('üìã Returning query data:', data.data);
                console.log('üÜî Query ID:', data.data.id);
                return data.data;
            } catch (error) {
                console.error('Failed to submit query:', error);
                throw error;
            }
        }

        async function getQueryResult(queryId) {
            try {
                // First check query status
                const statusUrl = `${API_BASE}/api/v1/queries/${queryId}`;
                console.log('üåê GET query status URL:', statusUrl);
                const statusResponse = await fetch(statusUrl, {
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (!statusResponse.ok) {
                    if (statusResponse.status === 404) {
                        return null;
                    }
                    throw new Error(`HTTP ${statusResponse.status}: ${statusResponse.statusText}`);
                }

                const statusData = await statusResponse.json();
                const query = statusData.data;
                console.log('üìä Query status:', query.status);

                // If failed, return error
                if (query.status === 'failed') {
                    return { status: 'failed', error: query.error_message || 'Query processing failed' };
                }

                // If not completed, return pending status
                if (query.status !== 'completed') {
                    return { status: query.status };
                }

                // Query is completed, fetch result
                const resultUrl = `${API_BASE}/api/v1/queries/${queryId}/result`;
                console.log('üåê GET query result URL:', resultUrl);
                const resultResponse = await fetch(resultUrl, {
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (!resultResponse.ok) {
                    throw new Error(`HTTP ${resultResponse.status}: ${resultResponse.statusText}`);
                }

                const resultData = await resultResponse.json();
                return resultData.data;
            } catch (error) {
                console.error('Failed to get query result:', error);
                throw error;
            }
        }

        /**
         * üéØ CONTEXT_ENGINEERING: Poll Query Result Until Completion
         * 
         * Mission: Wait for Azure OpenAI RAG processing to complete
         * Constraints: Max 60 attempts (2 minutes), 2s interval between polls
         * Reuses: getQueryResult() function, eva-api /api/v1/queries/{id}/result
         * Validates: Result status (pending/processing/completed/failed)
         * 
         * @param {string} queryId - UUID returned from submitQuery()
         * @param {number} maxAttempts - Maximum poll attempts (default 60)
         * @param {number} intervalMs - Milliseconds between polls (default 2000)
         * @returns {Promise<Object>} Completed query result with {answer, sources}
         * @throws {Error} Timeout after maxAttempts, network failures
         * 
         * üßπ HOUSEKEEPING: Uses async sleep (no timers to cleanup)
         * ‚ö†Ô∏è TODO: Add exponential backoff, circuit breaker pattern
         */
        async function pollQueryResult(queryId, maxAttempts = 60, intervalMs = 2000) {
            console.log('üîÑ Starting poll for query ID:', queryId);
            for (let i = 0; i < maxAttempts; i++) {
                console.log(`üìä Poll attempt ${i + 1}/${maxAttempts} for query:`, queryId);
                const result = await getQueryResult(queryId);
                console.log('üì¨ Poll result:', result);
                
                if (result && result.status === 'completed') {
                    return result;
                }
                
                if (result && result.status === 'failed') {
                    throw new Error(result.error || 'Query processing failed');
                }

                await new Promise(resolve => setTimeout(resolve, intervalMs));
            }

            throw new Error('Query timeout - result not available after 2 minutes');
        }

        /**
         * üéØ CONTEXT_ENGINEERING: Handle User Message Submission
         * 
         * Mission: Process user input, submit to RAG backend, display results
         * Constraints: 1-500 characters, requires space selection, bilingual responses
         * Reuses: submitQuery(), pollQueryResult(), addMessage() functions
         * Validates: Message not empty, spaces available, greeting detection
         * 
         * @returns {Promise<void>} Updates UI with EVA response or error
         * 
         * üßπ HOUSEKEEPING:
         * - Disables input during processing
         * - Re-enables input after completion/error
         * - Shows/hides typing indicator
         * 
         * ‚ö†Ô∏è TODO: Add input sanitization, rate limiting, message history limit
         */
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            messageInput.value = '';
            messageInput.disabled = true;
            sendBtn.disabled = true;

            // Check for greetings in both languages
            const greetings = ['hi', 'hello', 'hey', 'hi eva', 'hello eva', 
                             'bonjour', 'salut', 'bonjour eva', 'salut eva'];
            if (greetings.includes(message.toLowerCase())) {
                showTyping();
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideTyping();
                
                addMessage('eva', t('helloAgain'));
                
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
                return;
            }

            showTyping();

            try {
                if (spaces.length === 0) {
                    hideTyping();
                    addMessage('eva', `
                        <div class="error-message">
                            ${t('errorPrefix')} ${t('noSpaces')}
                        </div>
                    `);
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    return;
                }

                const spaceId = spaces[0].id;
                const queryResponse = await submitQuery(spaceId, message);
                console.log('‚úÖ Query submitted, response:', queryResponse);
                console.log('üîë Polling with ID:', queryResponse.id);
                const result = await pollQueryResult(queryResponse.id);
                
                hideTyping();

                let answerHTML = `<strong>${t('answer')}</strong><br><br>${result.answer}`;
                
                if (result.sources && result.sources.length > 0) {
                    answerHTML += `<br><br><strong>${t('sources')}</strong><br>`;
                    result.sources.forEach((source, idx) => {
                        answerHTML += `<div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                            ${idx + 1}. ${source.title || source.document_name || 'Document'} 
                            ${source.page ? `(${t('page')} ${source.page})` : ''}
                        </div>`;
                    });
                }

                addMessage('eva', answerHTML);

            } catch (error) {
                hideTyping();
                addMessage('eva', `
                    <div class="error-message">
                        ${t('errorPrefix')} ${error.message}<br><br>
                        ${t('tryAgain')}
                    </div>
                `);
            }

            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        window.addEventListener('load', initializeChat);

        /**
         * üßπ HOUSEKEEPING: Resource Cleanup on Page Unload
         * 
         * Mission: Prevent memory leaks and resource exhaustion
         * Cleans: Snowflakes, event listeners, timers
         * Monitors: Resource count, cleanup success
         * Validates: All resources properly disposed
         */
        window.addEventListener('beforeunload', () => {
            // Remove decorative elements
            document.querySelectorAll('.snowflake, .star').forEach(el => el.remove());
            
            // Clear any pending timers (if health monitoring implemented)
            // TODO: clearInterval(healthCheckTimer) when implemented
            
            console.log('üßπ HOUSEKEEPING: Resources cleaned up on page unload');
        });

        /**
         * üßπ HOUSEKEEPING: Health Monitoring (TODO)
         * 
         * Mission: Monitor API connectivity and app health
         * Creates: 30s interval timer for /health endpoint checks
         * Monitors: Response times, error rates, connection status
         * Validates: API availability, SLA compliance
         * 
         * ‚ö†Ô∏è TODO: Implement health check timer with exponential backoff
         */
        // let healthCheckTimer;
        // async function startHealthMonitoring() {
        //     healthCheckTimer = setInterval(async () => {
        //         try {
        //             const start = Date.now();
        //             const response = await fetch(`${API_BASE}/health`);
        //             const duration = Date.now() - start;
        //             
        //             if (response.ok) {
        //                 console.log(`‚úÖ Health check OK (${duration}ms)`);
        //             } else {
        //                 console.warn('‚ö†Ô∏è Health check degraded');
        //             }
        //         } catch (error) {
        //             console.error('‚ùå Health check failed:', error);
        //         }
        //     }, 30000);
        // }

        // Gift modal functions
        function updateGiftModal() {
            const g = t('gift');
            document.getElementById('giftTitle').innerHTML = g.title;
            document.getElementById('giftSubtitle').textContent = g.subtitle;
            document.getElementById('timeline1').innerHTML = `<strong>üìÖ ${currentLang === 'fr' ? '13 d√©cembre 2023' : 'December 13, 2023'}</strong> - ${g.visionBorn}`;
            document.getElementById('timeline2').innerHTML = `<strong>üí≠ 3 ${currentLang === 'fr' ? 'ans' : 'years'}</strong> - ${g.refined}`;
            document.getElementById('timeline3').innerHTML = `<strong>üöÄ 36 ${currentLang === 'fr' ? 'jours' : 'days'}</strong> - ${g.built}`;
            document.getElementById('visionTitle').textContent = g.originalVision;
            document.getElementById('visionFrom').innerHTML = `<strong>${g.from}:</strong> Presta, Marco M [NC]`;
            document.getElementById('visionSent').innerHTML = `<strong>${g.sent}:</strong> ${currentLang === 'fr' ? '13 d√©cembre 2023 21h34' : 'December 13, 2023 9:34 PM'}`;
            document.getElementById('visionSubject').innerHTML = `<strong>${g.subject}:</strong> EVA - ${currentLang === 'fr' ? "d'une id√©e au tableau Agile" : 'from an idea to the Agile board'}`;
            document.getElementById('dreamTitle').textContent = g.dreamExpanded;
            document.getElementById('evaEverywhere').innerHTML = `<strong>${g.evaEverywhere}</strong>`;
            document.getElementById('experiencingTitle').textContent = g.experiencing;
            document.getElementById('foundationText').innerHTML = g.foundationText;
            document.getElementById('journeyTitle').textContent = g.journey;
            document.getElementById('journeyText').innerHTML = g.journeyText;
            document.getElementById('todayText').innerHTML = g.todayText;
            document.getElementById('builtWith').innerHTML = g.builtWith;
        }

        function openGiftPopup() {
            document.getElementById('giftModal').classList.add('active');
        }

        function closeGiftPopup() {
            document.getElementById('giftModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('giftModal');
            if (e.target === modal) {
                closeGiftPopup();
            }
        });

        // Initialize app on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Update UI to match current language on load
            switchLanguage(currentLang);
        });
    </script>

    <!-- Gift Popup Modal -->
    <div id="giftModal" class="gift-modal">
        <div class="gift-content">
            <button class="gift-close" onclick="closeGiftPopup()">&times;</button>
            
            <div class="gift-header">
                <h2 id="giftTitle">üéÅ Marco's Gift to Canada & Canadians üá®üá¶</h2>
                <p class="subtitle" id="giftSubtitle">From vision to reality ‚Ä¢ 3 years in the making ‚Ä¢ Built in 36 days</p>
            </div>

            <div class="gift-body">
                <div class="timeline">
                    <div class="timeline-item" id="timeline1">
                        <strong>üìÖ December 13, 2023</strong> - The vision was born
                    </div>
                    <div class="timeline-item" id="timeline2">
                        <strong>üí≠ 3 years</strong> - Refined, planned, dreamed
                    </div>
                    <div class="timeline-item" id="timeline3">
                        <strong>üöÄ 36 days</strong> - From code to reality (November 2 - December 8, 2025)
                    </div>
                </div>

                <h3 id="visionTitle">The Original Vision</h3>
                <div class="vision-box">
                    <p id="visionFrom"><strong>From:</strong> Presta, Marco M [NC]<br>
                    <span id="visionSent"><strong>Sent:</strong> December 13, 2023 9:34 PM</span><br>
                    <span id="visionSubject"><strong>Subject:</strong> EVA - from an idea to the Agile board</span></p>
                    
                    <p>"That's how I envisioned EVA, ESDC Virtual Assistant, based on Todd's initial idea back in the Enterprise Chatbot project last year."</p>
                    
                    <p>"A citizen, a business enterprise or an employee calls the 1 800 O-Canada service phone number. EVA ESDC Virtual Assistant answers the phone, identifies itself, offers to speak in the client's language of choice, asks the client to state their request, proceeds with the client authentication and continues its workflow to process the client request to its successful completion."</p>
                </div>

                <h3 id="dreamTitle">The Dream Expanded</h3>
                <p id="evaEverywhere"><strong>EVA everywhere in Protected B environments:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>üéôÔ∏è AI-based IVR for citizens, business and employees</li>
                    <li>üí¨ Service Canada Chatbot & Insights</li>
                    <li>üéØ Benefits Finder for Citizens</li>
                    <li>üíª Chat portal that replicates ChatGPT capabilities</li>
                    <li>‚ôø Desktop companion of adaptive accessibility tools</li>
                    <li>üåê Second Language Tutor & Official Languages Translator</li>
                    <li>üè• CPPD medical adjudicator research assistant</li>
                    <li>üìä Grants & Contribution Summary generator</li>
                    <li>üîê SharePoint Information Categorization Tool</li>
                    <li>üìö Chat with your SharePoint data assistant</li>
                    <li>üë• HR consultant for employees</li>
                    <li>‚öôÔ∏è Developer's Pal</li>
                </ul>

                <h3 id="experiencingTitle">What You're Experiencing Now</h3>
                <p id="foundationText">This is <strong>EVA Domain Assistant</strong> - the foundation of that vision. Built with:</p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>‚úÖ <strong>Phase 1:</strong> Core API with Cosmos DB, Azure OpenAI, RAG pipeline</li>
                    <li>‚úÖ <strong>Phase 2:</strong> GraphQL, Redis rate limiting, full CRUD operations</li>
                    <li>‚úÖ <strong>Phase 3:</strong> WebSocket subscriptions, webhook broadcasting, DataLoader optimization</li>
                    <li>‚úÖ <strong>Chat UI:</strong> Bilingual (üá®üá¶ FR/EN), winter-themed, ready for 25 demo users</li>
                    <li>‚úÖ <strong>Production Ready:</strong> Deployed to Azure, complete documentation</li>
                </ul>

                <h3 id="journeyTitle">The Journey</h3>
                <p id="journeyText"><strong>36 days of intense development</strong> transformed years of vision into working reality:</p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>üèóÔ∏è Enterprise-grade API architecture</li>
                    <li>üîê Security-first design (Azure Entra ID, API keys, JWT)</li>
                    <li>‚ö° Performance optimized (DataLoader, Redis caching, circuit breakers)</li>
                    <li>üåç Bilingual from day one</li>
                    <li>üìñ Comprehensive documentation (5,500+ lines)</li>
                    <li>üß™ Fully tested (22/22 tests passing)</li>
                </ul>

                <div class="timeline">
                    <p style="text-align: center; font-size: 18px; margin: 0;">
                        <strong>"The future is bright.. I just hope we don't get blind by it."</strong>
                    </p>
                    <p style="text-align: center; margin: 10px 0 0 0; font-size: 14px;">
                        - Marco Presta, December 13, 2023
                    </p>
                </div>

                <p id="todayText"><strong>üá®üá¶ Today, December 8, 2025:</strong> That future is here. EVA is real. This is your gift to Canada and Canadians - accessible, bilingual, intelligent assistance powered by cutting-edge AI technology.</p>

                <div class="signature">
                    <p id="builtWith">Built with üíö by Marco Presta<br>
                    Artificial Intelligence, Robotics, and Business Automation Solutions (IITB)<br>
                    Employment and Social Development Canada<br>
                    <em>marco.presta@hrsdc-rhdcc.gc.ca</em></p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
